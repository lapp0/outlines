name: Comment on PR with Benchmarks

on:
  pull_request:
    branches: [main]

permissions:
  contents: read  # Read access for repository contents
  pull-requests: write  # Write access for pull requests

env:
  PYTHON_VERSION: "3.10"
  WORKING_DIR: ${{ github.workspace }}/benchmarks
  ARTIFACTS_DIR: ${{ github.workspace }}/artifacts

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install asv

    - name: Save comparison of PR against main branch
      run: |
        # ensure benchmarks are sane
        asv check -E existing
        # prepare main branch for comparison
        git remote add upstream https://github.com/${{ github.repository }}.git
        git fetch upstream main
	echo before
	git branch -r
        asv machine --yes
	echo after
	git branch -r
        asv continuous upstream/main HEAD --factor 1.1 --sort ratio --verbose
        echo 'BENCH_OUTPUT<<EOF' >> $GITHUB_ENV
        #asv compare upstream/main HEAD  --split --verbose >> $GITHUB_ENV
        #asv compare -f 1.1 upstream/main HEAD
        #echo 'EOF' >> $GITHUB_ENV

    - uses: actions/github-script@v7
      env:
        BENCH_OUTPUT: ${{env.BENCH_OUTPUT}}
      with:
        script: |
          const ENV_VARS = process.env
            const run_url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '\nBenchmarks completed.\n' + run_url + "\n" + ENV_VARS["BENCH_OUTPUT"]
          })
